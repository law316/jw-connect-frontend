<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat List + Firestore (Single File)</title>

<!-- Simple styling + dark mode -->
<style>
:root{
  --bg: #f2f5f9; --card:#fff; --primary:#4b79ff; --text:#1f2937;
}
[data-theme="dark"]{ --bg:#0b1220; --card:#0f1724; --primary:#6aa0ff; --text:#e6eef8; }
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);
}
.app {
  max-width:920px; margin:16px auto; padding:12px;
}
/* top controls */
.topbar{
  display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px;
}
.left-controls{display:flex; gap:8px; align-items:center;}
.btn { padding:8px 10px; border-radius:8px; border:none; cursor:pointer; background:var(--primary); color:white; }
.icon-btn { background:transparent; color:var(--text); border:1px solid rgba(0,0,0,0.06); padding:6px; border-radius:8px; cursor:pointer;}
.search { padding:8px 10px; border-radius:10px; border:1px solid #dfe6f3; min-width:220px; outline:none; }

/* layout */
.layout{ display:grid; grid-template-columns:360px 1fr; gap:12px; align-items:start; }
@media (max-width:880px){ .layout{grid-template-columns:1fr} .user-col{order:1} .chat-col{order:2} }

/* user list column */
.col { background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 14px rgba(20,20,40,0.04); }
.user-list { display:grid; gap:12px; max-height:72vh; overflow:auto; padding-right:6px; }

/* card */
.card { border-radius:12px; overflow:hidden; box-shadow:0 6px 10px rgba(0,0,0,0.04); cursor:pointer; transition:transform .15s, box-shadow .15s; background:var(--card); }
.card:hover{ transform:translateY(-4px); box-shadow:0 12px 20px rgba(10,10,30,0.08); }

/* image 70% of card height look */
.card-img{ width:100%; height:160px; object-fit:cover; display:block; }
.card-body{ padding:10px; }
.card-title{ font-weight:600; margin:2px 0 4px 0; }
.card-sub{ font-size:13px; color:gray; margin-bottom:8px; }

/* actions row */
.actions{ display:flex; gap:8px; align-items:center; }
.small-btn{ flex:1; padding:8px 6px; border-radius:8px; border:none; cursor:pointer; font-size:13px; }
.like{ background:#ff3b6c; color:white; }
.comment{ background:#2ecc71; color:white; }
.chat-open{ background:#4b79ff; color:white; }

/* counters inline */
.counter{ font-weight:600; margin-left:6px; }

/* chat column */
.chat-header{ display:flex; gap:12px; align-items:center; padding:12px; border-bottom:1px solid rgba(0,0,0,0.04); background:transparent; }
.chat-body{ padding:12px; height:62vh; overflow:auto; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); }
.msg{ display:inline-block; padding:10px 12px; border-radius:10px; margin:8px 0; max-width:70%; background:var(--card); box-shadow:0 3px 8px rgba(0,0,0,0.04); }
.msg.me{ background:var(--primary); color:white; margin-left:auto; }

.input-row{ display:flex; gap:8px; padding:12px; border-top:1px solid rgba(0,0,0,0.04); background:var(--card); border-radius:0 0 12px 12px; }
.input { flex:1; padding:10px 12px; border-radius:999px; border:1px solid #dfe6f3; outline:none; }

/* online dot */
.dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; vertical-align:middle; }
.online { background:#34c759; box-shadow:0 0 6px rgba(52,199,89,0.25); }
.offline { background:#d1d5db; }

/* small helpers */
.hint{ font-size:13px; color:gray; margin-top:8px; }
.count-bubble{ background:rgba(0,0,0,0.06); padding:6px 8px; border-radius:999px; font-weight:600; font-size:13px; }
.empty { text-align:center; color:gray; padding:22px; }
</style>
</head>
<body>

<div class="app" id="appRoot" data-theme="light">
  <div class="topbar">
    <div class="left-controls">
      <div style="font-weight:700; font-size:18px;">Social Chat</div>
      <input id="searchInput" class="search" placeholder="Search users..." />
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <button id="themeToggle" class="icon-btn">üåô</button>
      <div id="userInfo" class="hint">Not signed in</div>
    </div>
  </div>

  <div class="layout">
    <!-- USER LIST COLUMN -->
    <div class="col user-col">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:700">People</div>
        <div class="hint">Online: <span id="onlineCount">0</span></div>
      </div>

      <div id="userList" class="user-list">
        <!-- user cards injected here -->
      </div>
    </div>

    <!-- CHAT COLUMN -->
    <div class="col chat-col" id="chatColumn">
      <div id="chatPlaceholder" class="empty">
        Select a person to open chat.<br/><small class="hint">Click a card or the Chat button.</small>
      </div>

      <div id="chatPanel" style="display:none; flex-direction:column; height:100%;">
        <div class="chat-header">
          <div style="display:flex; gap:10px; align-items:center;">
            <img id="chatAvatar" src="" width="48" height="48" style="border-radius:10px; object-fit:cover;" />
            <div>
              <div id="chatName" style="font-weight:700"></div>
              <div id="chatLocation" class="hint"></div>
            </div>
          </div>

          <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <div id="chatLastSeen" class="hint"></div>
            <button id="closeChat" class="icon-btn">Close</button>
          </div>
        </div>

        <div id="chatBody" class="chat-body"></div>

        <div class="input-row">
          <input id="msgInput" class="input" placeholder="Type a message..." />
          <button id="sendBtn" class="btn">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase (compat) CDN for simpler inline usage -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ====================== REPLACE WITH YOUR FIREBASE CONFIG ======================
  Get this from Firebase console (Project settings)
  ***************************************************************************** */
const firebaseConfig = {
  apiKey: "REPLACE_ME",
  authDomain: "REPLACE_ME",
  projectId: "REPLACE_ME",
  storageBucket: "REPLACE_ME",
  messagingSenderId: "REPLACE_ME",
  appId: "REPLACE_ME"
};
/* =========================================================================== */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------- simple anonymous auth so we have uid ---------- */
let currentUser = null;
async function anonSignIn(){
  try{
    const res = await auth.signInAnonymously();
    currentUser = res.user;
    // store temporary displayName if none (for demo we ask)
    if(!localStorage.getItem('displayName')){
      const name = prompt("Enter your display name for this demo (will be saved locally):", "You");
      localStorage.setItem('displayName', name || 'You');
    }
    // create or update profile in users collection
    const profile = {
      name: localStorage.getItem('displayName'),
      location: localStorage.getItem('location') || 'Unknown',
      avatar: localStorage.getItem('avatar') || `https://i.pravatar.cc/150?u=${currentUser.uid}`,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('users').doc(currentUser.uid).set(profile, {merge:true});
    // show in UI
    document.getElementById('userInfo').innerText = profile.name + " (you)";
    startPresenceHeartbeat();
  } catch(e){
    console.error("Auth error:", e);
    alert("Firebase auth failed. Check console and Firebase project settings.");
  }
}
anonSignIn();

/* ---------- Presence (heartbeat) - updates lastSeen every 15s ---------- */
let heartbeatInterval = null;
function startPresenceHeartbeat(){
  if(!currentUser) return;
  async function beat(){
    try{
      await db.collection('users').doc(currentUser.uid).set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
    }catch(e){ console.warn("Heartbeat failed", e); }
  }
  beat();
  heartbeatInterval = setInterval(beat, 15000);
}

/* ---------- Sample seed data (only if users collection empty) ----------
   In production you'd have registration flow that writes user docs.
   This snippet checks if there are users other than current and seeds demo users.
--------------------------------------------------------------------------*/
async function seedDemoUsersIfNeeded(){
  const snap = await db.collection('users').limit(1).get();
  if(!snap.empty) return; // already have users
  const demo = [
    { id: 'u_sarah', name:'Sarah Chisom', location:'Lagos, NG', avatar:'https://i.pravatar.cc/300?img=5', likes:0, comments:0, lastSeen: firebase.firestore.Timestamp.now() },
    { id: 'u_daniel', name:'Daniel Peter', location:'Abuja, NG', avatar:'https://i.pravatar.cc/300?img=11', likes:0, comments:0, lastSeen: firebase.firestore.Timestamp.now() },
    { id: 'u_amaka', name:'Amaka Joy', location:'Enugu, NG', avatar:'https://i.pravatar.cc/300?img=20', likes:0, comments:0, lastSeen: firebase.firestore.Timestamp.now() },
    { id: 'u_john', name:'John Kelvin', location:'Port Harcourt, NG', avatar:'https://i.pravatar.cc/300?img=8', likes:0, comments:0, lastSeen: firebase.firestore.Timestamp.now() }
  ];
  const batch = db.batch();
  demo.forEach(d => {
    const ref = db.collection('users').doc(d.id);
    batch.set(ref, d);
  });
  await batch.commit();
}
seedDemoUsersIfNeeded();

/* ---------- UI Helpers & State ---------- */
const userListEl = document.getElementById('userList');
const searchInput = document.getElementById('searchInput');
const onlineCountEl = document.getElementById('onlineCount');

let usersCache = []; // array of user docs
let selectedChatUser = null;
let messagesUnsub = null;

/* ---------- Listen to users collection real-time ---------- */
function attachUsersListener(){
  db.collection('users').orderBy('name').onSnapshot(snapshot => {
    usersCache = [];
    snapshot.forEach(doc => {
      const data = doc.data(); data.id = doc.id;
      usersCache.push(data);
    });
    renderUserList();
  }, err => console.error("Users listener error", err));
}
attachUsersListener();

/* ---------- Render user cards with search & online detection ---------- */
function renderUserList(){
  const q = searchInput.value.trim().toLowerCase();
  userListEl.innerHTML = '';
  const now = Date.now();
  let onlineCount = 0;

  const filtered = usersCache.filter(u => {
    if(!u) return false;
    const name = (u.name||'').toLowerCase();
    const loc = (u.location||'').toLowerCase();
    return name.includes(q) || loc.includes(q);
  });

  if(filtered.length === 0){
    userListEl.innerHTML = `<div class="empty">No users found.</div>`;
  }

  filtered.forEach(u => {
    // determine online (lastSeen within 30s)
    let online = false;
    if(u.lastSeen && u.lastSeen.toMillis){
      const last = u.lastSeen.toMillis();
      online = (now - last) < 30000;
    }
    if(online) onlineCount++;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img class="card-img" src="${u.avatar || 'https://i.pravatar.cc/300'}" />
      <div class="card-body">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div class="card-title">${u.name || 'Unknown'}</div>
            <div class="card-sub">${u.location || ''}</div>
          </div>
          <div style="text-align:right;">
            <div title="${online ? 'Online' : 'Last seen: '+(u.lastSeen? new Date(u.lastSeen.toMillis()).toLocaleString():'unknown') }">
              <span class="dot ${online? 'online':'offline'}"></span>
            </div>
            <div style="margin-top:8px;"><span class="count-bubble">${u.likes || 0} ‚ù§</span></div>
          </div>
        </div>

        <div class="actions" style="margin-top:10px;">
          <button class="small-btn chat-open" data-id="${u.id}">Chat</button>
          <button class="small-btn like" data-id="${u.id}">‚ù§ <span class="counter">${u.likes||0}</span></button>
          <button class="small-btn comment" data-id="${u.id}">üí¨ <span class="counter">${u.comments||0}</span></button>
        </div>
      </div>
    `;
    // card click (open chat)
    card.querySelector('.chat-open').addEventListener('click', (ev)=> {
      ev.stopPropagation();
      openChatWithUser(u);
    });
    card.querySelector('.like').addEventListener('click', ev => {
      ev.stopPropagation(); likeUser(u.id);
    });
    card.querySelector('.comment').addEventListener('click', ev => {
      ev.stopPropagation(); commentUser(u.id);
    });

    userListEl.appendChild(card);
  });

  onlineCountEl.innerText = onlineCount;
}

/* ---------- Search ---------- */
searchInput.addEventListener('input', () => renderUserList());

/* ---------- Like & Comment updates (safe merge) ---------- */
async function likeUser(userId){
  const ref = db.collection('users').doc(userId);
  // use a transaction to increment safely
  try{
    await db.runTransaction(async tx => {
      const snap = await tx.get(ref);
      const curr = snap.exists ? snap.data().likes || 0 : 0;
      tx.set(ref, { likes: curr + 1 }, {merge:true});
    });
  }catch(e){ console.error("Like failed", e); }
}

async function commentUser(userId){
  const text = prompt("Write a comment:");
  if(!text) return;
  try{
    // increment comments and save a comment doc under users/{userId}/comments (optional)
    await db.runTransaction(async tx => {
      const ref = db.collection('users').doc(userId);
      const snap = await tx.get(ref);
      const curr = snap.exists ? snap.data().comments || 0 : 0;
      tx.set(ref, { comments: curr + 1 }, {merge:true});
    });
    await db.collection('users').doc(userId).collection('comments').add({
      text, fromUid: currentUser ? currentUser.uid : null, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }catch(e){ console.error("Comment failed", e); }
}

/* ---------- Chat logic ---------- */
const chatPanel = document.getElementById('chatPanel');
const chatBody = document.getElementById('chatBody');
const chatNameEl = document.getElementById('chatName');
const chatLocationEl = document.getElementById('chatLocation');
const chatAvatar = document.getElementById('chatAvatar');
const chatLastSeen = document.getElementById('chatLastSeen');
const chatPlaceholder = document.getElementById('chatPlaceholder');
const closeChatBtn = document.getElementById('closeChat');
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('msgInput');

closeChatBtn.addEventListener('click', closeChat);

function chatIdFor(u1, u2){
  // deterministic chatId for a 1:1 chat
  const a = u1 < u2 ? u1 : u2;
  const b = u1 < u2 ? u2 : u1;
  return `chat_${a}_${b}`;
}

async function openChatWithUser(userDoc){
  selectedChatUser = userDoc;
  chatPlaceholder.style.display = 'none';
  chatPanel.style.display = 'flex';
  chatNameEl.innerText = userDoc.name;
  chatLocationEl.innerText = userDoc.location || '';
  chatAvatar.src = userDoc.avatar || '';
  updateChatLastSeen(userDoc);

  // subscribe to messages between currentUser.uid and userDoc.id
  if(messagesUnsub) messagesUnsub();

  const partnerUid = userDoc.id;
  const localUid = currentUser ? currentUser.uid : 'anon';
  const id = chatIdFor(localUid, partnerUid);
  const messagesRef = db.collection('chats').doc(id).collection('messages').orderBy('createdAt');

  messagesUnsub = messagesRef.onSnapshot(snapshot => {
    chatBody.innerHTML = '';
    snapshot.forEach(doc => {
      const m = doc.data();
      const div = document.createElement('div');
      div.className = 'msg' + (m.from === (currentUser?currentUser.uid:'anon') ? ' me' : '');
      const time = m.createdAt && m.createdAt.toDate ? formatTime(m.createdAt.toDate()) : '';
      div.innerHTML = `<div style="font-size:14px;">${escapeHtml(m.text)}</div><div style="font-size:11px; opacity:0.7; margin-top:6px;">${m.fromName?escapeHtml(m.fromName):''} ‚Ä¢ ${time}</div>`;
      chatBody.appendChild(div);
    });
    // scroll bottom
    chatBody.scrollTop = chatBody.scrollHeight;
  }, err => console.error("Messages listener error", err));
}

/* send message */
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });

async function sendMessage(){
  const text = msgInput.value.trim();
  if(!text || !selectedChatUser) return;
  const fromUid = currentUser ? currentUser.uid : 'anon';
  const fromName = localStorage.getItem('displayName') || 'You';
  const partnerUid = selectedChatUser.id;
  const id = chatIdFor(fromUid, partnerUid);
  const messagesRef = db.collection('chats').doc(id).collection('messages');
  try{
    await messagesRef.add({
      text, from: fromUid, fromName, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgInput.value = '';
    // write last message summary to chat doc for listing (optional)
    await db.collection('chats').doc(id).set({
      lastMessage: text,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      members: [fromUid, partnerUid]
    }, {merge:true});
  }catch(e){ console.error("Send failed", e); }
}

/* update chat partner last-seen text */
function updateChatLastSeen(userDoc){
  if(userDoc.lastSeen && userDoc.lastSeen.toMillis){
    const diff = Date.now() - userDoc.lastSeen.toMillis();
    if(diff < 60000) chatLastSeen.innerText = 'Online';
    else chatLastSeen.innerText = 'Last seen ' + timeAgo(userDoc.lastSeen.toDate());
  } else {
    chatLastSeen.innerText = 'Last seen unknown';
  }
}

/* close chat */
function closeChat(){
  selectedChatUser = null;
  if(messagesUnsub) messagesUnsub();
  chatPanel.style.display = 'none';
  chatPlaceholder.style.display = 'block';
}

/* ---------- Utility formatting ---------- */
function formatTime(d){
  return d.toLocaleString([], { hour: '2-digit', minute: '2-digit', month:'short', day:'numeric' });
}
function timeAgo(d){
  const s = Math.floor((Date.now() - d.getTime())/1000);
  if(s < 60) return `${s}s ago`;
  if(s < 3600) return `${Math.floor(s/60)}m ago`;
  if(s < 86400) return `${Math.floor(s/3600)}h ago`;
  return `${Math.floor(s/86400)}d ago`;
}
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* ---------- Theme toggle ---------- */
const themeToggle = document.getElementById('themeToggle');
const appRoot = document.getElementById('appRoot');
themeToggle.addEventListener('click', () => {
  const cur = appRoot.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  appRoot.setAttribute('data-theme', cur);
  themeToggle.innerText = cur === 'dark' ? '‚òÄÔ∏è' : 'üåô';
});

/* ---------- small helper: show local cached user on UI (when auth ready) ---------- */
auth.onAuthStateChanged(u => {
  if(u){
    currentUser = u;
    document.getElementById('userInfo').innerText = (localStorage.getItem('displayName') || 'You') + " (you)";
    // ensure doc exists
    db.collection('users').doc(currentUser.uid).set({
      name: localStorage.getItem('displayName') || 'You',
      avatar: localStorage.getItem('avatar') || `https://i.pravatar.cc/150?u=${currentUser.uid}`,
      location: localStorage.getItem('location') || 'Unknown',
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  } else {
    // no user; try anonymous sign in again
    anonSignIn();
  }
});

/* ---------- tidy: update UI presence from cache every 10s (to re-evaluate online flags) ---------- */
setInterval(() => {
  renderUserList();
}, 10000);

</script>
</body>
</html>
